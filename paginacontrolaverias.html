<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Control de Averías</title>
<style>
body { font-family: Arial; text-align: center; margin-top: 30px; }
input, select, button { display:block; margin:8px auto; padding:6px; width:260px; }
.hidden { display:none; }
#alertaAverias{
  background:red;
  color:white;
  padding:10px;
  font-weight:bold;
  animation: blink 1s infinite;
  margin-bottom:15px;
}
@keyframes blink{
  0%{opacity:1}
  50%{opacity:0.3}
  100%{opacity:1}
}
.averia{
  border:1px solid #aaa;
  padding:10px;
  margin:10px auto;
  width:550px;
  text-align:left;
}
.userBox{
  border:1px solid #aaa;
  margin:5px auto;
  padding:5px;
  width:300px;
}
</style>
</head>
<body>

<!-- REGISTRO -->
<div id="register" class="hidden">
  <h2>Registro</h2>
  <input id="regUser" placeholder="Usuario">
  <input id="regPassword" type="password" placeholder="Contraseña">
  <label><input type="checkbox" id="newIsAdmin"> Administrador</label>
  <button onclick="registerUser()">Crear usuario</button>
  <button onclick="showLogin()">Cancelar</button>
</div>

<!-- LOGIN -->
<div id="login">
  <h2>Login</h2>
  <input id="loginUserInput" placeholder="Usuario">
  <input id="loginPassword" type="password" placeholder="Contraseña">
  <button onclick="loginUser()">Entrar</button>
  <hr>
  <input id="masterKey" type="password" placeholder="Clave maestra">
  <button onclick="goRegister()">Registrar</button>
</div>

<!-- HOME -->
<div id="home" class="hidden">
  <div id="alertaAverias" class="hidden"></div>
  <h2 id="welcome"></h2>
  <button onclick="showAverias()">Ver averías</button>
  <button onclick="logout()">Cerrar sesión</button>

  <div id="adminPanel" class="hidden">
    <h3>Usuarios registrados</h3>
    <div id="listaUsuarios"></div>

    <h3>Tareas completadas</h3>
    <div id="tareasCompletadas"></div>
  </div>
</div>

<!-- AVERÍAS -->
<div id="averias" class="hidden">
  <h2>Control de Averías</h2>
  <input id="texto" placeholder="Descripción">
  <input type="file" id="archivo" accept="image/*,video/*">
  <button onclick="addAveria()">Añadir avería</button>
  <div id="lista"></div>
  <button onclick="showHome()">Volver</button>
</div>

<script>
const CLAVE_REGISTRO = "1234";

function hideAll(){
  register.classList.add("hidden");
  login.classList.add("hidden");
  home.classList.add("hidden");
  averias.classList.add("hidden");
}

function showLogin(){ hideAll(); login.classList.remove("hidden"); }

function showHome(){
  hideAll();
  home.classList.remove("hidden");
  actualizarAviso();

  let users = JSON.parse(localStorage.getItem("users")) || [];
  let me = users.find(u=>u.user===localStorage.getItem("currentUser"));

  if(me && me.isAdmin){
    adminPanel.classList.remove("hidden");
    mostrarUsuarios();
    mostrarTareasCompletadas();
  }else{
    adminPanel.classList.add("hidden");
  }
}

function showAverias(){
  hideAll();
  averias.classList.remove("hidden");
  showAveriasList();
}

function goRegister(){
  if(masterKey.value !== CLAVE_REGISTRO) return alert("Clave incorrecta");
  hideAll();
  register.classList.remove("hidden");
}

function registerUser(){
  let users = JSON.parse(localStorage.getItem("users")) || [];
  if(users.find(u=>u.user===regUser.value)) return alert("Usuario existe");

  users.push({
    user: regUser.value,
    password: regPassword.value,
    isAdmin: newIsAdmin.checked
  });

  localStorage.setItem("users", JSON.stringify(users));
  showLogin();
}

function loginUser(){
  let users = JSON.parse(localStorage.getItem("users")) || [];
  let u = users.find(x =>
    x.user === loginUserInput.value &&
    x.password === loginPassword.value
  );
  if(!u) return alert("Datos incorrectos");

  localStorage.setItem("currentUser", u.user);
  welcome.innerText = "Bienvenido " + u.user;
  showHome();
}

function logout(){
  localStorage.removeItem("currentUser");
  showLogin();
}

/* AÑADIR AVERÍA */
function addAveria(){
  if(!texto.value) return alert("Describe la avería");
  const archivoInput = document.getElementById("archivo");

  if(archivoInput.files.length>0){
    const reader = new FileReader();
    reader.onload = e => guardarAveria(e.target.result);
    reader.readAsDataURL(archivoInput.files[0]);
  }else{
    guardarAveria(null);
  }
}

function guardarAveria(archivoData){
  let averias = JSON.parse(localStorage.getItem("averias")) || [];
  averias.push({
    texto: texto.value,
    asignado: null,
    fecha: new Date().toLocaleString(),
    completada: false,
    completadaPor: null,
    horaCompletada: null,
    archivo: archivoData
  });
  localStorage.setItem("averias", JSON.stringify(averias));
  texto.value="";
  archivo.value="";
  showAveriasList();
  actualizarAviso();
}

/* LISTA AVERÍAS (IGUAL QUE EL ORIGINAL) */
function showAveriasList(){
  lista.innerHTML="";
  let averias = JSON.parse(localStorage.getItem("averias")) || [];
  let users = JSON.parse(localStorage.getItem("users")) || [];
  let me = users.find(u=>u.user===localStorage.getItem("currentUser"));

  averias.forEach((a,i)=>{
    if(a.completada) return;

    let div=document.createElement("div");
    div.className="averia";

    if(me.isAdmin){
      let sel=document.createElement("select");
      sel.innerHTML =
        `<option value="">-- sin asignar --</option>` +
        users.filter(u=>!u.isAdmin).map(u=>
          `<option value="${u.user}" ${a.asignado===u.user?"selected":""}>${u.user}</option>`
        ).join("");
      sel.onchange=()=>{
        averias[i].asignado = sel.value || null;
        localStorage.setItem("averias", JSON.stringify(averias));
        showAveriasList();
        actualizarAviso();
      };
      div.appendChild(sel);
    }

    let p1=document.createElement("p");
    p1.innerHTML = `<b>Avería:</b> ${a.texto}`;
    div.appendChild(p1);

    if(a.archivo){
      if(a.archivo.startsWith("data:image")){
        let img=document.createElement("img");
        img.src=a.archivo;
        img.style.maxWidth="200px";
        div.appendChild(img);
      }else if(a.archivo.startsWith("data:video")){
        let vid=document.createElement("video");
        vid.src=a.archivo;
        vid.controls=true;
        vid.style.maxWidth="200px";
        div.appendChild(vid);
      }
    }

    let p2=document.createElement("p");
    p2.innerHTML = `<b>Asignada a:</b> ${a.asignado || "Sin asignar"}`;
    let p3=document.createElement("p");
    p3.textContent = a.fecha;

    div.appendChild(p2);
    div.appendChild(p3);

    if(!me.isAdmin && a.asignado===me.user){
      let btn=document.createElement("button");
      btn.textContent="Terminar tarea";
      btn.onclick=()=>{
        averias[i].completada=true;
        averias[i].completadaPor=me.user;
        averias[i].horaCompletada=new Date().toLocaleString();
        localStorage.setItem("averias", JSON.stringify(averias));
        showAveriasList();
        actualizarAviso();
      };
      div.appendChild(btn);
    }

    lista.appendChild(div);
  });
}

/* AVISO */
function actualizarAviso(){
  let users = JSON.parse(localStorage.getItem("users")) || [];
  let me = users.find(u=>u.user===localStorage.getItem("currentUser"));

  if(!me || me.isAdmin){
    alertaAverias.classList.add("hidden");
    return;
  }

  let averias = JSON.parse(localStorage.getItem("averias")) || [];
  let n = averias.filter(a=>a.asignado===me.user && !a.completada).length;

  if(n>0){
    alertaAverias.textContent = `⚠ Tienes ${n} avería(s) pendiente(s)`;
    alertaAverias.classList.remove("hidden");
  }else{
    alertaAverias.classList.add("hidden");
  }
}

/* TAREAS COMPLETADAS */
function mostrarTareasCompletadas(){
  let averias = JSON.parse(localStorage.getItem("averias")) || [];
  tareasCompletadas.innerHTML="";

  averias.forEach((a,i)=>{
    if(!a.completada) return;

    let div=document.createElement("div");
    div.className="averia";
    div.innerHTML = `<b>${a.texto}</b><br>Completada por: ${a.completadaPor} a las ${a.horaCompletada}`;

    let btn=document.createElement("button");
    btn.textContent="Borrar";
    btn.onclick=()=>{
      if(confirm("¿Borrar definitivamente?")){
        averias.splice(i,1);
        localStorage.setItem("averias", JSON.stringify(averias));
        mostrarTareasCompletadas();
      }
    };

    div.appendChild(btn);
    tareasCompletadas.appendChild(div);
  });
}

/* USUARIOS (ÚNICA MEJORA) */
function mostrarUsuarios(){
  let users = JSON.parse(localStorage.getItem("users")) || [];
  let current = localStorage.getItem("currentUser");
  listaUsuarios.innerHTML="";

  users.forEach((u,i)=>{
    let div=document.createElement("div");
    div.className="userBox";
    div.innerHTML = `<b>${u.user}</b> ${u.isAdmin?"(admin)":""}`;

    if(u.user !== current){
      let btn=document.createElement("button");
      btn.textContent="Borrar";
      btn.onclick=()=>{
        if(confirm("¿Borrar usuario definitivamente?")){
          users.splice(i,1);
          localStorage.setItem("users", JSON.stringify(users));
          mostrarUsuarios();
        }
      };
      div.appendChild(btn);
    }

    listaUsuarios.appendChild(div);
  });
}

localStorage.getItem("currentUser") ? showHome() : showLogin();
</script>
</body>
</html>
